{"additions":19,"assignees":[],"author":{"login":"barrettj12"},"baseRefName":"develop","body":"[Smoke](https://github.com/juju/juju/runs/6224161870?check_suite_focus=true#step:8:13) and [Snapcraft](https://github.com/juju/juju/runs/6224161450?check_suite_focus=true#step:8:8) tests are returning a strange error:\r\n```\r\nERROR cannot load ssh client keys: mkdir /home/runner/.local/share/juju: permission denied\r\n```","changedFiles":3,"closed":true,"closedAt":"2022-05-19T01:08:56Z","comments":[{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"All the failures seem to be coming back to permission errors. I've also noticed that the failures all come after building a Juju snap, installing it, and trying to use it. My theory is that the Juju snap doesn't have enough permissions to do stuff (access go, access ssh keys, connect to lxd, etc).","createdAt":"2022-05-09T04:09:17Z","includesCreatedEdit":false,"isMinimized":true,"minimizedReason":"RESOLVED","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"I'm also noticing that when we try to install the Juju snap, it gives a warning:\r\n```\r\nWarning: flag --classic ignored for strictly confined snap juju\r\n```\r\nThis seems like it could be causing permission errors.","createdAt":"2022-05-09T04:22:51Z","includesCreatedEdit":false,"isMinimized":true,"minimizedReason":"RESOLVED","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"Using [this action](https://github.com/mxschmitt/action-tmate), I was able to leave the machines running and create a remote ssh session that you can use.\r\n\r\n- Snapcraft / linux-amd64 test:\r\n  - Web shell: https://tmate.io/t/vcHcxkQRWah4mfMzPZYjPQag6\r\n  - SSH: `ssh vcHcxkQRWah4mfMzPZYjPQag6@sfo2.tmate.io`\r\n- Smoke / Smoke test:\r\n  - Web shell: https://tmate.io/t/5EzZjzZJ7nZc95srgrknYmLZc\r\n  - SSH: `ssh 5EzZjzZJ7nZc95srgrknYmLZc@nyc1.tmate.io`\r\n- Smoke / Upgrade (latest/stable, localhost) test:\r\n  - Web shell: https://tmate.io/t/39BtTEy8yx8F3gBuSN95zbANN\r\n  - SSH: `ssh 39BtTEy8yx8F3gBuSN95zbANN@sfo2.tmate.io`\r\n\r\nWould appreciate if someone else can take a look at this, as I've definitely reached the limits of my Juju/lxd/snap/linux knowledge.","createdAt":"2022-05-09T04:32:29Z","includesCreatedEdit":false,"isMinimized":true,"minimizedReason":"OUTDATED","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"~Using snap's `--devmode` flag fixed most of the permission errors. Snap seemed to be ignoring the `--classic` flag when installing the Juju snap, which meant it couldn't e.g. bootstrap new controllers.~ Edit: yeah, but we shouldn't have to do this - the required connections should be declared in `snapcraft.yaml`, and this should make them accessible by Juju.\r\n\r\nThe smoke tests were also running into versioning issues. I've already reported the bug [here](https://bugs.launchpad.net/juju/+bug/1971909) - the fix I've employed is changing the `juju_version()` function, but maybe we should think about whether this calls for a Juju change.","createdAt":"2022-05-09T23:55:02Z","includesCreatedEdit":true,"isMinimized":true,"minimizedReason":"RESOLVED","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"**Update on Smoke / Upgrade tests:** part of the workflow is to build the Juju 3.0 snap, install it, then try to upgrade an old controller:\r\n```\r\njuju upgrade-controller -v --build-agent\r\n```\r\nWith the --build-agent flag, it's trying to use Go to rebuild the agent binary. However, the $PATH seen by the Juju 3.0 snap is different to the system $PATH. Therefore, Juju cannot find Go and rebuild the binary, which is causing the test to fail.\r\n\r\n**Edit:** this is a snap confinement problem. Juju 2 snaps used `confinement: classic`, so Juju's PATH would be the same as the user's PATH. Juju 3 snaps are using `confinement: strict`, so the PATH is set by `snap` and is different from the user's PATH.","createdAt":"2022-05-10T02:59:29Z","includesCreatedEdit":true,"isMinimized":true,"minimizedReason":"OFF_TOPIC","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"# BLOCKED\r\n\r\nThere are some changes in #14015 that need to be merged through to develop before this PR can land.\r\n\r\nOnce that happens, I need to remember to change $JUJU_OLDV to `2.9/stable` in the Smoke/Upgrade test.","createdAt":"2022-05-11T05:08:09Z","includesCreatedEdit":false,"isMinimized":true,"minimizedReason":"OUTDATED","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"I did `snap connections juju` after installing the new Juju snap, to see which connections were working.\r\n\r\nIn the Smoke and Snapcraft tests, the output is:\r\n```\r\nInterface        Plug                       Slot           Notes\r\ncontent          juju:peers                 -              -\r\ndesktop          juju:desktop               :desktop       -\r\nhome             juju:home                  :home          -\r\nlxd              juju:lxd                   -              -\r\nnetwork          juju:network               :network       -\r\nnetwork-bind     juju:network-bind          :network-bind  -\r\npersonal-files   juju:config-lxd            -              -\r\npersonal-files   juju:dot-aws               -              -\r\npersonal-files   juju:dot-azure             -              -\r\npersonal-files   juju:dot-google            -              -\r\npersonal-files   juju:dot-kubernetes        -              -\r\npersonal-files   juju:dot-local-share-juju  -              -\r\npersonal-files   juju:dot-maas              -              -\r\npersonal-files   juju:dot-openstack         -              -\r\npersonal-files   juju:dot-oracle            -              -\r\nssh-public-keys  juju:ssh-public-keys       -              -\r\n```\r\nI believe slots with `-` are disconnected, which would explain why it's struggling to connect to lxd and the ssh keys.\r\n\r\nFor the Upgrade tests, the connections seem to be fine.","createdAt":"2022-05-13T05:01:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"In a local lxd container, I tried installing the Juju 3 snap and manually granting permissions with `snap connect`, but it didn't seem to help. I continued to get the error\r\n```\r\nERROR cannot load ssh client keys: mkdir /home/runner/.local/share/juju: permission denied\r\n```","createdAt":"2022-05-13T06:44:21Z","includesCreatedEdit":false,"isMinimized":true,"minimizedReason":"RESOLVED","reactionGroups":[]},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"Ok, I manually `snap connect`ed things, and now the Snapcraft and Smoke tests are passing. The Upgrade tests are broken due to a [known issue](https://bugs.launchpad.net/juju/+bug/1812191), and the macOS client tests are a [separate bag of worms](14022). I'll tidy up and merge.","createdAt":"2022-05-18T01:33:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[]}],"commits":[{"authoredDate":"2022-05-18T04:03:56Z","authors":[{"email":"jordan.barrett@canonical.com","id":"MDQ6VXNlcjkwMTk1OTg1","login":"barrettj12","name":"Jordan Barrett"}],"committedDate":"2022-05-18T04:03:56Z","messageBody":"","messageHeadline":"Fix `juju_version` for tags","oid":"756d0ece12f1c82ecd5385ac218f991c9b364148"},{"authoredDate":"2022-05-18T04:04:19Z","authors":[{"email":"jordan.barrett@canonical.com","id":"MDQ6VXNlcjkwMTk1OTg1","login":"barrettj12","name":"Jordan Barrett"}],"committedDate":"2022-05-18T04:04:19Z","messageBody":"","messageHeadline":"Manually connect dangerous 3.0 snap","oid":"fa5a3201565e82e33fa661ebe47b44c9181ca714"}],"createdAt":"2022-05-06T05:02:11Z","deletions":5,"files":[{"path":".github/workflows/smoke.yml","additions":9,"deletions":2},{"path":".github/workflows/snap.yml","additions":7,"deletions":1},{"path":"tests/includes/juju.sh","additions":3,"deletions":2}],"headRefName":"develop-ci","headRepository":{"id":"R_kgDOHCPPuw","name":"juju"},"headRepositoryOwner":{"id":"MDQ6VXNlcjkwMTk1OTg1","name":"Jordan Mitchell Barrett","login":"barrettj12"},"id":"PR_kwDOATf6-843ZIGC","isCrossRepository":true,"isDraft":false,"labels":[],"latestReviews":[{"author":{"login":"tlm"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-08T22:00:29Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED"},{"author":{"login":"wallyworld"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-19T01:08:21Z","includesCreatedEdit":false,"reactionGroups":[],"state":"APPROVED"}],"maintainerCanModify":false,"mergeCommit":{"oid":"cdab383c9e69995e9d1574cd028c07a44f2afe4c"},"mergeStateStatus":"UNKNOWN","mergeable":"UNKNOWN","mergedAt":"2022-05-19T01:08:56Z","mergedBy":{"login":"wallyworld"},"milestone":null,"number":14006,"potentialMergeCommit":null,"projectCards":[],"reactionGroups":[],"reviewDecision":"APPROVED","reviewRequests":[],"reviews":[{"author":{"login":"tlm"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-06T05:14:31Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED"},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-06T05:15:59Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED"},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-06T05:59:53Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED"},{"author":{"login":"barrettj12"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-06T06:54:51Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED"},{"author":{"login":"tlm"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-08T22:00:29Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED"},{"author":{"login":"wallyworld"},"authorAssociation":"MEMBER","body":"","submittedAt":"2022-05-19T01:08:21Z","includesCreatedEdit":false,"reactionGroups":[],"state":"APPROVED"}],"state":"MERGED","statusCheckRollup":[{"__typename":"CheckRun","name":"Build (linux, amd64)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:42Z","completedAt":"2022-05-18T04:10:38Z","detailsUrl":"https://github.com/juju/juju/runs/6482727552?check_suite_focus=true"},{"__typename":"CheckRun","name":"cla-check","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:04:55Z","detailsUrl":"https://github.com/juju/juju/runs/6482727540?check_suite_focus=true"},{"__typename":"CheckRun","name":"Client Tests (ubuntu-latest)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:42Z","completedAt":"2022-05-18T04:19:16Z","detailsUrl":"https://github.com/juju/juju/runs/6482727542?check_suite_focus=true"},{"__typename":"CheckRun","name":"Smoke","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:24:17Z","detailsUrl":"https://github.com/juju/juju/runs/6482727730?check_suite_focus=true"},{"__typename":"CheckRun","name":"linux-amd64","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:43Z","completedAt":"2022-05-18T04:17:06Z","detailsUrl":"https://github.com/juju/juju/runs/6482727589?check_suite_focus=true"},{"__typename":"CheckRun","name":"Lint","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:45Z","completedAt":"2022-05-18T04:19:57Z","detailsUrl":"https://github.com/juju/juju/runs/6482727541?check_suite_focus=true"},{"__typename":"CheckRun","name":"Client Tests (macOS-latest)","status":"COMPLETED","conclusion":"FAILURE","startedAt":"2022-05-18T04:04:47Z","completedAt":"2022-05-18T04:45:46Z","detailsUrl":"https://github.com/juju/juju/runs/6482727580?check_suite_focus=true"},{"__typename":"CheckRun","name":"Build (linux, arm64)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:10:09Z","detailsUrl":"https://github.com/juju/juju/runs/6482727595?check_suite_focus=true"},{"__typename":"CheckRun","name":"Build (linux, s390x)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:43Z","completedAt":"2022-05-18T04:10:01Z","detailsUrl":"https://github.com/juju/juju/runs/6482727639?check_suite_focus=true"},{"__typename":"CheckRun","name":"Build (linux, ppc64le)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:10:03Z","detailsUrl":"https://github.com/juju/juju/runs/6482727683?check_suite_focus=true"},{"__typename":"CheckRun","name":"Build (windows, amd64)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:42Z","completedAt":"2022-05-18T04:09:49Z","detailsUrl":"https://github.com/juju/juju/runs/6482727723?check_suite_focus=true"},{"__typename":"CheckRun","name":"Build (darwin, amd64)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:09:47Z","detailsUrl":"https://github.com/juju/juju/runs/6482727773?check_suite_focus=true"},{"__typename":"CheckRun","name":"Upgrade (latest/stable, localhost)","status":"COMPLETED","conclusion":"CANCELLED","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:08:17Z","detailsUrl":"https://github.com/juju/juju/runs/6482727835?check_suite_focus=true"},{"__typename":"CheckRun","name":"Schema","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:41Z","completedAt":"2022-05-18T04:08:29Z","detailsUrl":"https://github.com/juju/juju/runs/6482727707?check_suite_focus=true"},{"__typename":"CheckRun","name":"Upgrade (latest/stable, microk8s)","status":"COMPLETED","conclusion":"FAILURE","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:07:59Z","detailsUrl":"https://github.com/juju/juju/runs/6482727881?check_suite_focus=true"},{"__typename":"CheckRun","name":"Upgrade (latest/beta, localhost)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:04:50Z","detailsUrl":"https://github.com/juju/juju/runs/6482727928?check_suite_focus=true"},{"__typename":"CheckRun","name":"Upgrade (latest/beta, microk8s)","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-05-18T04:04:44Z","completedAt":"2022-05-18T04:04:49Z","detailsUrl":"https://github.com/juju/juju/runs/6482727971?check_suite_focus=true"},{"__typename":"StatusContext","name":"","context":"check-multi-juju","state":"SUCCESS","status":"","conclusion":"","startedAt":"0001-01-01T00:00:00Z","completedAt":"0001-01-01T00:00:00Z","detailsUrl":"","targetUrl":"https://juju-temp-jenkins.haza.dev/job/github-juju-check-jobs/334/"}],"title":"[JUJU-1057] Fix GitHub Actions on `develop` branch","updatedAt":"2022-05-19T01:09:45Z","url":"https://github.com/juju/juju/pull/14006"}
